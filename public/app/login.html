<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - SOCIMOB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/bauhaus.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body class="bauhaus-page">
    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="bauhaus-panel w-full max-w-md p-10 bg-white">
            <div class="text-center mb-10">
                <div class="bauhaus-badge justify-center mb-4">üè† SOCIMOB</div>
                <h1 class="text-3xl font-black text-[var(--bauhaus-black)] uppercase tracking-tight">√Årea do Corretor</h1>
                <p class="text-[var(--bauhaus-ink)] font-semibold">Sistema de Gest√£o Imobili√°ria</p>
            </div>

            <form id="loginForm" class="space-y-6">
                <div class="space-y-2">
                    <label class="block text-sm font-extrabold text-[var(--bauhaus-black)] uppercase tracking-wide">
                        E-mail
                    </label>
                    <input
                        id="email"
                        type="email"
                        required
                        class="w-full bauhaus-input"
                        placeholder="seu@email.com"
                    />
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-extrabold text-[var(--bauhaus-black)] uppercase tracking-wide">
                        Senha
                    </label>
                    <input
                        id="senha"
                        type="password"
                        required
                        class="w-full bauhaus-input"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    />
                </div>

                <div id="errorMsg" class="hidden bg-red-50 border-4 border-[var(--bauhaus-red)] text-[var(--bauhaus-black)] px-4 py-3 text-sm font-semibold"></div>

                <button
                    type="submit"
                    id="btnLogin"
                    class="w-full bauhaus-button disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <span id="btnText">Entrar</span>
                    <span id="btnLoading" class="hidden">Entrando...</span>
                </button>
            </form>

            <div class="mt-4 text-center text-xs text-[var(--bauhaus-ink)] font-semibold">
                <p>Vers√£o HTML/jQuery - Servidor √önico PHP</p>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';

        $(document).ready(function() {
            console.log('‚úì Login page carregada');

            // Verificar se j√° est√° logado
            const token = localStorage.getItem('token');
            if (token) {
                console.log('‚úì Token encontrado, redirecionando...');
                window.location.href = 'dashboard.html';
                return;
            }

            $('#loginForm').on('submit', function(e) {
                e.preventDefault();
                console.log('üîê Formul√°rio submetido');
                handleLogin();
            });
        });

        function handleLogin() {
            const email = $('#email').val();
            const senha = $('#senha').val();

            console.log('üìß Email:', email);
            
            // Mostrar loading
            $('#btnLogin').prop('disabled', true);
            $('#btnText').hide();
            $('#btnLoading').show();
            $('#errorMsg').hide();

            console.log('üì§ Enviando requisi√ß√£o:', {
                url: API_URL + '/auth/login',
                method: 'POST',
                data: { email, password: senha }
            });

            $.ajax({
                url: API_URL + '/auth/login',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ email, password: senha }),
                beforeSend: function(xhr, settings) {
                    console.log('üìã Request details:', {
                        url: settings.url,
                        method: settings.type,
                        headers: xhr.getAllResponseHeaders(),
                        data: settings.data
                    });
                },
                success: function(response) {
                    console.log('‚úÖ Login bem-sucedido!', response);

                    if (response.success && response.token) {
                        // Salvar dados
                        localStorage.setItem('token', response.token);
                        localStorage.setItem('user', JSON.stringify(response.user));

                        // Redirecionar
                        if (response.user.requires_subscription) {
                            console.log('‚Üí Redirecionando para assinatura...');
                            window.location.href = 'assinatura.html';
                        } else {
                            console.log('‚Üí Redirecionando para dashboard...');
                            window.location.href = 'dashboard.html';
                        }
                    } else {
                        showError(response.message || 'Erro ao fazer login');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('‚ùå Erro no login:', error);
                    
                    let errorMsg = 'Erro ao conectar com o servidor';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg = xhr.responseJSON.message;
                    }
                    
                    showError(errorMsg);
                },
                complete: function() {
                    // Esconder loading
                    $('#btnLogin').prop('disabled', false);
                    $('#btnText').show();
                    $('#btnLoading').hide();
                }
            });
        }

        function showError(message) {
            $('#errorMsg').text(message).removeClass('hidden');
        }
    </script>
</body>
</html>
