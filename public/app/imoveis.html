<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Im√≥veis - SOCIMOB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="js/toast.js"></script>
    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
</head>
<body class="bg-slate-50">
    <!-- Navbar -->
    <nav class="bg-slate-900 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold uppercase tracking-tighter cursor-pointer" onclick="window.location.href='dashboard.html'">SOCIMOB</h1>
            <div class="flex items-center gap-4">
                <span id="userName" class="font-medium"></span>
                <button id="btnLogout" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded font-bold text-sm">Sair</button>
            </div>
        </div>
    </nav>

    <!-- Conte√∫do -->
    <div class="container mx-auto p-8">
        <div class="bg-white rounded-lg shadow-xl p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-black text-slate-900 uppercase">Im√≥veis</h2>
                <div class="flex gap-3">
                    <button id="btnImportarAPI" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 font-bold uppercase">
                        üì• Importar via API
                    </button>
                    <button id="btnNovoImovel" class="bg-slate-900 hover:bg-slate-800 text-white px-6 py-3 font-bold uppercase">
                        + Novo Im√≥vel
                    </button>
                </div>
            </div>

            <!-- Filtros -->
            <div class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                <input type="text" id="searchImovel" placeholder="Buscar im√≥vel..." 
                    class="px-4 py-2 border-2 border-slate-200 rounded-none focus:border-slate-900 outline-none">
                <select id="filterTipo" class="px-4 py-2 border-2 border-slate-200 rounded-none focus:border-slate-900 outline-none">
                    <option value="">Todos os tipos</option>
                    <option value="casa">Casa</option>
                    <option value="apartamento">Apartamento</option>
                    <option value="terreno">Terreno</option>
                    <option value="comercial">Comercial</option>
                </select>
                <select id="filterStatus" class="px-4 py-2 border-2 border-slate-200 rounded-none focus:border-slate-900 outline-none">
                    <option value="">Todos os status</option>
                    <option value="disponivel">Dispon√≠vel</option>
                    <option value="reservado">Reservado</option>
                    <option value="vendido">Vendido</option>
                </select>
                <select id="filterFinalidade" class="px-4 py-2 border-2 border-slate-200 rounded-none focus:border-slate-900 outline-none">
                    <option value="">Todas finalidades</option>
                    <option value="venda">Venda</option>
                    <option value="aluguel">Aluguel</option>
                </select>
            </div>

            <!-- Tabela de Im√≥veis com DataTables -->
            <div class="overflow-x-auto">
                <table id="tabelaImoveis" class="display w-full">
                    <thead>
                        <tr>
                            <th>Foto</th>
                            <th>T√≠tulo</th>
                            <th>Tipo</th>
                            <th>Finalidade</th>
                            <th>Pre√ßo</th>
                            <th>√Årea</th>
                            <th>Local</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dados ser√£o carregados via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Importar via API -->
    <div id="modalImportarAPI" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full my-8">
            <h3 class="text-2xl font-black text-slate-900 mb-6 uppercase">üì• Importar Im√≥veis via API</h3>
            <form id="formImportarAPI" class="space-y-6">
                <div>
                    <label class="block text-sm font-bold text-slate-900 mb-2">Portal/Fonte *</label>
                    <select name="fonte" required class="w-full px-4 py-2 border-2 border-slate-200 rounded-none focus:border-slate-900 outline-none">
                        <option value="">Selecione o portal</option>
                        <option value="exclusiva">üè† Exclusiva Lar Im√≥veis (API Configurada)</option>
                        <option value="vivareal">Viva Real</option>
                        <option value="zapimoveis">Zap Im√≥veis</option>
                        <option value="olx">OLX Im√≥veis</option>
                        <option value="imovelweb">Imovel Web</option>
                        <option value="custom">API Customizada</option>
                    </select>
                </div>
                
                <div id="camposAPI" class="hidden space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-slate-900 mb-2">URL da API *</label>
                        <input type="url" name="api_url" class="w-full px-4 py-2 border-2 border-slate-200 rounded-none focus:border-slate-900 outline-none" 
                            placeholder="https://api.exemplo.com/imoveis">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-900 mb-2">API Key (se necess√°rio)</label>
                        <input type="text" name="api_key" class="w-full px-4 py-2 border-2 border-slate-200 rounded-none focus:border-slate-900 outline-none" 
                            placeholder="sua-chave-api">
                    </div>
                </div>

                <div class="bg-blue-50 border-2 border-blue-200 p-4 rounded">
                    <h4 class="font-bold text-slate-900 mb-2">‚ÑπÔ∏è Informa√ß√µes</h4>
                    <ul class="text-sm text-slate-700 space-y-1 list-disc list-inside">
                        <li>Configure suas credenciais de API em <a href="configuracoes.html#integracoes" class="text-blue-600 underline">Configura√ß√µes ‚Üí Integra√ß√µes</a></li>
                        <li>A importa√ß√£o pode levar alguns minutos dependendo da quantidade de im√≥veis</li>
                        <li>Im√≥veis duplicados ser√£o identificados e pulados</li>
                    </ul>
                </div>

                <div id="progressoImportacao" class="hidden">
                    <div class="bg-slate-100 rounded-full h-4 overflow-hidden">
                        <div id="barraProgresso" class="bg-blue-600 h-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p id="textoProgresso" class="text-center text-sm text-slate-600 mt-2">Importando...</p>
                </div>

                <div class="flex gap-4 justify-end mt-6">
                    <button type="button" id="btnCancelarImportacao" class="px-6 py-3 border-2 border-slate-900 text-slate-900 font-bold uppercase">Cancelar</button>
                    <button type="submit" id="btnIniciarImportacao" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold uppercase">Iniciar Importa√ß√£o</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Novo Im√≥vel -->
    <div id="modalImovel" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-4xl w-full my-8">
            <h3 class="text-2xl font-black text-slate-900 mb-6 uppercase">Novo Im√≥vel</h3>
            <form id="formImovel" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-sm font-bold text-slate-900 mb-2">T√≠tulo *</label>
                        <input type="text" name="titulo" required class="w-full px-4 py-2 border-2 border-slate-200 rounded-none focus:border-slate-900 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-900 mb-2">Tipo *</label>
                        <select name="tipo" required class="w-full px-4 py-2 border-2 border-slate-200 rounded-none focus:border-slate-900 outline-none">
                            <option value="casa">Casa</option>
                            <option value="apartamento">Apartamento</option>
                            <option value="terreno">Terreno</option>
                            <option value="comercial">Comercial</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-900 mb-2">Finalidade *</label>
                        <select name="finalidade" required class="w-full px-4 py-2 border-2 border-slate-200 rounded-none focus:border-slate-900 outline-none">
                            <option value="venda">Venda</option>
                            <option value="aluguel">Aluguel</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-900 mb-2">Pre√ßo (R$) *</label>
                        <input type="number" name="preco" required step="0.01" class="w-full px-4 py-2 border-2 border-slate-200 rounded-none focus:border-slate-900 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-900 mb-2">√Årea (m¬≤)</label>
                        <input type="number" name="area" class="w-full px-4 py-2 border-2 border-slate-200 rounded-none focus:border-slate-900 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-900 mb-2">Quartos</label>
                        <input type="number" name="quartos" class="w-full px-4 py-2 border-2 border-slate-200 rounded-none focus:border-slate-900 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-900 mb-2">Banheiros</label>
                        <input type="number" name="banheiros" class="w-full px-4 py-2 border-2 border-slate-200 rounded-none focus:border-slate-900 outline-none">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-bold text-slate-900 mb-2">Endere√ßo *</label>
                        <input type="text" name="endereco" required class="w-full px-4 py-2 border-2 border-slate-200 rounded-none focus:border-slate-900 outline-none">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-bold text-slate-900 mb-2">Descri√ß√£o</label>
                        <textarea name="descricao" rows="4" class="w-full px-4 py-2 border-2 border-slate-200 rounded-none focus:border-slate-900 outline-none"></textarea>
                    </div>
                </div>
                <div class="flex gap-4 justify-end mt-6">
                    <button type="button" id="btnCancelarImovel" class="px-6 py-3 border-2 border-slate-900 text-slate-900 font-bold uppercase">Cancelar</button>
                    <button type="submit" class="px-6 py-3 bg-slate-900 hover:bg-slate-800 text-white font-bold uppercase">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        let imoveis = [];

        $(document).ready(function() {
            checkAuth();
            loadImoveis();

            $('#btnLogout').on('click', handleLogout);
            $('#btnNovoImovel').on('click', () => $('#modalImovel').removeClass('hidden'));
            $('#btnCancelarImovel').on('click', () => $('#modalImovel').addClass('hidden'));
            $('#formImovel').on('submit', handleSaveImovel);
            // Filtros agora s√£o nativos do DataTables
            
            // Importa√ß√£o via API
            $('#btnImportarAPI').on('click', abrirModalImportacao);
            $('#btnCancelarImportacao').on('click', fecharModalImportacao);
            $('[name="fonte"]').on('change', toggleCamposAPI);
            $('#formImportarAPI').on('submit', iniciarImportacao);
        });

        function checkAuth() {
            const token = localStorage.getItem('token');
            const userStr = localStorage.getItem('user');
            if (!token || !userStr) {
                window.location.href = 'login.html';
                return;
            }
            const user = JSON.parse(userStr);
            $('#userName').text(user.name);
        }

        function loadImoveis() {
            const token = localStorage.getItem('token');

            if (!token) {
                showToast('Erro: Token n√£o encontrado', 'error');
                renderDataTable([]);
                return;
            }

            $.ajax({
                url: API_URL + '/admin/imoveis',
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + token },
                success: function(response) {
                    const raw = response.data || [];
                    imoveis = raw.map(normalizeImovel);
                    console.log('‚úì Im√≥veis carregados:', imoveis.length);
                    renderDataTable(imoveis);
                },
                error: function(error) {
                    console.error('Erro ao carregar im√≥veis:', error);
                    showToast('Erro ao carregar im√≥veis', 'error');
                    renderDataTable([]);
                }
            });
        }

        function normalizeImovel(item) {
            // Parse imagens se for string JSON
            let imagens = [];
            if (item.imagens) {
                if (typeof item.imagens === 'string') {
                    try {
                        imagens = JSON.parse(item.imagens);
                    } catch (e) {
                        console.warn('Erro ao parsear imagens:', e);
                        imagens = [];
                    }
                } else if (Array.isArray(item.imagens)) {
                    imagens = item.imagens;
                }
            }
            
            return {
                id: item.id,
                titulo: item.titulo || item.codigo || 'Imovel',
                tipo: item.tipo_imovel || item.tipo || 'casa',
                finalidade: item.finalidade_imovel || item.finalidade || 'venda',
                preco: item.valor_venda || item.preco || 0,
                area: item.area_total || item.area || null,
                quartos: item.dormitorios || item.quartos || 0,
                banheiros: item.banheiros || 0,
                vagas: item.garagem || item.vagas || 0,
                endereco: item.logradouro || item.endereco || '',
                cidade: item.cidade || '',
                estado: item.estado || '',
                bairro: item.bairro || '',
                status: item.active === false ? 'vendido' : 'disponivel',
                descricao: item.descricao || '',
                imagens: imagens,
                primeira_imagem: imagens.length > 0 ? imagens[0] : null
            };
        }
        function renderDataTable(data) {
            // Destruir DataTable existente se houver
            if ($.fn.DataTable.isDataTable('#tabelaImoveis')) {
                $('#tabelaImoveis').DataTable().destroy();
            }

            // Preparar dados para DataTable
            const tableData = data.map(imovel => [
                imovel.primeira_imagem 
                    ? `<img src="${imovel.primeira_imagem}" alt="${imovel.titulo}" class="w-16 h-16 object-cover rounded" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"><span class="text-4xl hidden">${getTipoIcon(imovel.tipo)}</span>`
                    : `<span class="text-4xl">${getTipoIcon(imovel.tipo)}</span>`,
                imovel.titulo,
                `<span class="capitalize">${imovel.tipo}</span>`,
                `<span class="capitalize">${imovel.finalidade}</span>`,
                `R$ ${formatPrice(imovel.preco)}`,
                imovel.area ? `${imovel.area}m¬≤` : '-',
                imovel.endereco,
                getStatusBadge(imovel.status),
                `<div class="flex gap-2">
                    <button onclick="editImovel(${imovel.id})" class="text-blue-600 hover:text-blue-800 text-xl" title="Editar">‚úèÔ∏è</button>
                    <button onclick="deleteImovel(${imovel.id})" class="text-red-600 hover:text-red-800 text-xl" title="Excluir">üóëÔ∏è</button>
                </div>`
            ]);

            // Inicializar DataTable
            $('#tabelaImoveis').DataTable({
                data: tableData,
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json'
                },
                pageLength: 10,
                order: [[1, 'asc']], // Ordenar por t√≠tulo
                columnDefs: [
                    { orderable: false, targets: [0, 8] }, // Desabilitar ordena√ß√£o em Foto e A√ß√µes
                    { className: 'text-center', targets: [0, 3, 7, 8] }
                ]
            });
        }

        function getStatusBadge(status) {
            const badges = {
                'disponivel': '<span class="px-3 py-1 bg-green-100 text-green-800 text-xs font-bold rounded uppercase">Dispon√≠vel</span>',
                'reservado': '<span class="px-3 py-1 bg-yellow-100 text-yellow-800 text-xs font-bold rounded uppercase">Reservado</span>',
                'vendido': '<span class="px-3 py-1 bg-red-100 text-red-800 text-xs font-bold rounded uppercase">Vendido</span>'
            };
            return badges[status] || badges['disponivel'];
        }

        function filterImoveis() {
            const search = $('#searchImovel').val().toLowerCase();
            const tipo = $('#filterTipo').val();
            const status = $('#filterStatus').val();
            const finalidade = $('#filterFinalidade').val();

            const filtered = imoveis.filter(imovel => {
                const matchSearch = !search || 
                    imovel.titulo.toLowerCase().includes(search) ||
                    imovel.endereco.toLowerCase().includes(search);
                const matchTipo = !tipo || imovel.tipo === tipo;
                const matchStatus = !status || imovel.status === status;
                const matchFinalidade = !finalidade || imovel.finalidade === finalidade;

                return matchSearch && matchTipo && matchStatus && matchFinalidade;
            });

            renderImoveis(filtered);
        }

        function handleSaveImovel(e) {
            e.preventDefault();
            const token = localStorage.getItem('token');
            const formData = {
                titulo: $('[name="titulo"]').val(),
                tipo: $('[name="tipo"]').val(),
                finalidade: $('[name="finalidade"]').val(),
                preco: parseFloat($('[name="preco"]').val()),
                area: parseFloat($('[name="area"]').val()) || null,
                quartos: parseInt($('[name="quartos"]').val()) || null,
                banheiros: parseInt($('[name="banheiros"]').val()) || null,
                endereco: $('[name="endereco"]').val(),
                descricao: $('[name="descricao"]').val()
            };

            console.log('üíæ Salvando im√≥vel:', formData);
            showToast('Im√≥vel salvo com sucesso! (simulado)', 'success');
            $('#modalImovel').addClass('hidden');
            $('#formImovel')[0].reset();
        }

        function editImovel(id) {
            showToast('Editar im√≥vel #' + id + ' (em desenvolvimento)', 'info');
        }

        function deleteImovel(id) {
            if (confirm('Deseja realmente excluir este im√≥vel?')) {
                console.log('üóëÔ∏è Deletando im√≥vel:', id);
            }
        }

        function getTipoIcon(tipo) {
            const icons = {
                'casa': 'üè†',
                'apartamento': 'üè¢',
                'terreno': 'üèûÔ∏è',
                'comercial': 'üè™'
            };
            return icons[tipo] || 'üèòÔ∏è';
        }

        function formatPrice(price) {
            return price.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
        }

        // === IMPORTA√á√ÉO VIA API ===
        async function abrirModalImportacao() {
            $('#modalImportarAPI').removeClass('hidden');
            $('#formImportarAPI')[0].reset();
            $('#camposAPI').addClass('hidden');
            $('#progressoImportacao').addClass('hidden');
            
            // Carregar configura√ß√µes da API do tenant
            try {
                const token = localStorage.getItem('token');
                const response = await $.ajax({
                    url: `${API_URL}/admin/settings`,
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.tenant && response.tenant.api_url_externa) {
                    console.log('‚úì Configura√ß√µes carregadas:', {
                        api_url: response.tenant.api_url_externa,
                        has_token: !!response.tenant.api_token_externa
                    });
                    
                    // Preencher campos hidden com as configura√ß√µes
                    $('[name="api_url"]').val(response.tenant.api_url_externa);
                    $('[name="api_key"]').val(response.tenant.api_token_externa || '');
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar configura√ß√µes:', error);
            }
        }

        function fecharModalImportacao() {
            $('#modalImportarAPI').addClass('hidden');
        }

        function toggleCamposAPI() {
            const fonte = $('[name="fonte"]').val();
            if (fonte === 'custom') {
                $('#camposAPI').removeClass('hidden');
                $('[name="api_url"]').attr('required', true);
            } else {
                $('#camposAPI').addClass('hidden');
                $('[name="api_url"]').attr('required', false);
            }
        }

        let importJobInterval = null;

        function iniciarImportacao(e) {
            e.preventDefault();

            const fonte = $('[name="fonte"]').val();
            const api_url = $('[name="api_url"]').val();
            const api_key = $('[name="api_key"]').val();
            const token = localStorage.getItem('token');

            if (!fonte) {
                showToast('Selecione um portal/fonte para importar', 'warning');
                return;
            }

            if (!token) {
                showToast('Erro: Token n√£o encontrado', 'error');
                return;
            }

            console.log('üì• Iniciando importa√ß√£o:', { fonte, api_url });

            $('#btnIniciarImportacao').prop('disabled', true).text('Importando...');
            $('#progressoImportacao').removeClass('hidden');
            $('#barraProgresso').css('width', '10%');
            $('#textoProgresso').text('Conectando √† API...');
            
            // Preparar dados para o backend
            const hoje = new Date();
            const trintaDiasAtras = new Date();
            trintaDiasAtras.setDate(hoje.getDate() - 30);
            
            const dados = {
                fonte: fonte,  // Backend espera 'fonte', n√£o 'origem'
                periodoInicial: trintaDiasAtras.toISOString().split('T')[0],
                periodoFinal: hoje.toISOString().split('T')[0],
                incluirDetalhes: true,
                processarMidia: true,
                atualizarExistentes: true
            };
            
            console.log('üì§ Dados da requisi√ß√£o:', dados);

            $.ajax({
                url: `${API_URL}/importacoes/imoveis`,
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify(dados),
                success: function(response) {
                    if (!response || response.success === false) {
                        const errorMsg = response?.error || response?.message || 'Erro ao importar im√≥veis';
                        showToast('Erro ao importar imoveis\n\n' + errorMsg, 'error', 6000);
                        resetImportacaoUI();
                        return;
                    }

                    // Importa√ß√£o s√≠ncrona - resultado imediato
                    const resultado = response.data || {};
                    const importados = resultado.importados || 0;
                    const duplicados = resultado.duplicados || 0;
                    const erros = resultado.erros || 0;
                    
                    showToast(
                        `‚úÖ Importa√ß√£o conclu√≠da!\n\n` +
                        `Importados: ${importados}\n` +
                        `Duplicados: ${duplicados}\n` +
                        `Erros: ${erros}`,
                        'success',
                        8000
                    );
                    
                    resetImportacaoUI();
                    loadImoveis(); // Recarregar lista
                },
                error: function(xhr) {
                    const errorMsg = xhr.responseJSON?.error || xhr.responseJSON?.message || 'Erro desconhecido';
                        showToast('Erro ao importar imoveis\n\n' + errorMsg, 'error', 6000);

                    resetImportacaoUI();
                }
            });
        }

        function acompanharImportacao(jobId) {
            const token = localStorage.getItem('token');
            if (!token) {
                showToast('Erro: Token n√£o encontrado', 'error');
                resetImportacaoUI();
                return;
            }

            if (importJobInterval) {
                clearInterval(importJobInterval);
                importJobInterval = null;
            }

            const atualizar = function() {
                $.ajax({
                    url: `${API_URL}/admin/imoveis/importar/${jobId}`,
                    method: 'GET',
                    headers: { 'Authorization': 'Bearer ' + token },
                    success: function(response) {
                        const data = response.data || {};
                        const total = data.total || 0;
                        const processados = data.processados || 0;

                        let progress = 10;
                        if (total > 0) {
                            progress = Math.min(95, Math.round((processados / total) * 100));
                        }
                        if (data.status === 'agendado') {
                            progress = Math.max(progress, 15);
                        }
                        if (data.status === 'processando') {
                            progress = Math.max(progress, 30);
                        }

                        $('#barraProgresso').css('width', progress + '%');
                        $('#textoProgresso').text(`Importando... ${progress}%`);

                        if (data.status === 'concluido') {
                            clearInterval(importJobInterval);
                            importJobInterval = null;
                            $('#barraProgresso').css('width', '100%');
                            $('#textoProgresso').text('Conclu√≠do!');

                            const resultado = data.resultado || {};
                            const importados = resultado.importados || 0;
                            const duplicados = resultado.duplicados || 0;
                            const erros = resultado.erros || 0;
                            const totalFinal = data.total || (importados + duplicados);

                            const mensagem = `Importa√ß√£o conclu√≠da com sucesso!

` +
                                  `‚Ä¢ ${importados} im√≥veis importados
` +
                                  `‚Ä¢ ${duplicados} duplicados (atualizados)
` +
                                  `‚Ä¢ ${erros} erros
` +
                                  `‚Ä¢ Total processado: ${totalFinal}`;

                            showToast(mensagem, 'success', 6000);
                            fecharModalImportacao();
                            loadImoveis();
                            resetImportacaoUI(false);
                        }

                        if (data.status === 'falhou') {
                            clearInterval(importJobInterval);
                            importJobInterval = null;
                            const erro = data.erro || 'Erro ao importar imoveis. Verifique os logs.';
                            showToast(erro, 'error', 6000);
                            resetImportacaoUI();
                        }
                    },
                    error: function(xhr) {
                        const errorMsg = xhr.responseJSON?.error || 'Erro ao consultar o job';
                        showToast('Erro ao importar imoveis\n\n' + errorMsg, 'error', 6000);

                        clearInterval(importJobInterval);
                        importJobInterval = null;
                        resetImportacaoUI();
                    }
                });
            };

            atualizar();
            importJobInterval = setInterval(atualizar, 2000);
        }

        function resetImportacaoUI(resetProgress = true) {
            $('#btnIniciarImportacao').prop('disabled', false).text('Iniciar Importa√ß√£o');
            if (resetProgress) {
                $('#progressoImportacao').addClass('hidden');
                $('#barraProgresso').css('width', '0%');
                $('#textoProgresso').text('Importando...');
            }
        }

        function handleLogout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
