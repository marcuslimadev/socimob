<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funil de Leads - SOCIMOB</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="sidebar.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="sidebar.js"></script>
    <style>
        body { background: #0f172a; color: #f8fafc; min-height: 100vh; overflow-x: hidden; }
        .page-container { padding: 2rem; }
        .page-title { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; }
        .kanban-board { display: flex; gap: 1.5rem; overflow-x: auto; padding-bottom: 2rem; }
        .kanban-column {
            min-width: 320px;
            background: rgba(30, 41, 59, 0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 1rem;
        }
        .column-header {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.875rem;
        }
        .col-leads { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }
        .col-contato { background: rgba(234, 179, 8, 0.2); color: #fbbf24; border: 1px solid rgba(234, 179, 8, 0.3); }
        .col-interesse { background: rgba(168, 85, 247, 0.2); color: #c084fc; border: 1px solid rgba(168, 85, 247, 0.3); }
        .col-negociacao { background: rgba(249, 115, 22, 0.2); color: #fb923c; border: 1px solid rgba(249, 115, 22, 0.3); }
        .col-fechado { background: rgba(34, 197, 94, 0.2); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.3); }
        .lead-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.8));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: move;
            transition: all 0.2s;
        }
        .lead-card:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="mb-4">
            <h1 class="page-title">Funil de Vendas</h1>
            <p class="text-muted">Gerencie o andamento dos seus leads</p>
        </div>

        <div class="kanban-board" id="kanbanBoard">
            <div class="kanban-column">
                <div class="column-header col-leads">
                    <i class="bi bi-person-plus me-2"></i>Leads <span class="badge bg-light text-dark ms-2">0</span>
                </div>
                <div id="colLeads" class="column-content"></div>
            </div>

            <div class="kanban-column">
                <div class="column-header col-contato">
                    <i class="bi bi-telephone me-2"></i>Primeiro Contato <span class="badge bg-light text-dark ms-2">0</span>
                </div>
                <div id="colContato" class="column-content"></div>
            </div>

            <div class="kanban-column">
                <div class="column-header col-interesse">
                    <i class="bi bi-heart me-2"></i>Interesse <span class="badge bg-light text-dark ms-2">0</span>
                </div>
                <div id="colInteresse" class="column-content"></div>
            </div>

            <div class="kanban-column">
                <div class="column-header col-negociacao">
                    <i class="bi bi-cash me-2"></i>Negociação <span class="badge bg-light text-dark ms-2">0</span>
                </div>
                <div id="colNegociacao" class="column-content"></div>
            </div>

            <div class="kanban-column">
                <div class="column-header col-fechado">
                    <i class="bi bi-check-circle me-2"></i>Fechados <span class="badge bg-light text-dark ms-2">0</span>
                </div>
                <div id="colFechado" class="column-content"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = '/api';
        let leads = [];

        $(document).ready(function() {
            checkAuth();
            loadLeads();
            setInterval(loadLeads, 30000);
        });

        function checkAuth() {
            if (!localStorage.getItem('token')) window.location.href = 'login.html';
        }

        function loadLeads() {
            $.ajax({
                url: API_URL + '/leads',
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') },
                success: function(response) {
                    leads = response.data || [];
                    renderKanban();
                },
                error: function() {
                    leads = [
                        { id: 1, nome: 'João Silva', telefone: '(11) 98765-4321', stage: 'leads', valor_investimento: 250000 },
                        { id: 2, nome: 'Maria Santos', telefone: '(11) 98765-4322', stage: 'contato' },
                        { id: 3, nome: 'Pedro Costa', telefone: '(11) 98765-4323', stage: 'interesse', valor_investimento: 450000 },
                        { id: 4, nome: 'Ana Oliveira', telefone: '(11) 98765-4324', stage: 'negociacao', valor_investimento: 180000 },
                        { id: 5, nome: 'Carlos Souza', telefone: '(11) 98765-4325', stage: 'fechado', valor_investimento: 320000 }
                    ];
                    renderKanban();
                }
            });
        }

        function renderKanban() {
            const columns = {
                leads: $('#colLeads'),
                contato: $('#colContato'),
                interesse: $('#colInteresse'),
                negociacao: $('#colNegociacao'),
                fechado: $('#colFechado')
            };

            Object.values(columns).forEach(col => col.empty());

            leads.forEach(lead => {
                const stage = lead.stage || 'leads';
                if (columns[stage]) {
                    columns[stage].append(createLeadCard(lead));
                }
            });

            Object.keys(columns).forEach(key => {
                const count = leads.filter(l => (l.stage || 'leads') === key).length;
                $(`.col-${key} .badge`).text(count);
            });
        }

        function createLeadCard(lead) {
            return $(`
                <div class="lead-card" data-id="${lead.id}">
                    <strong class="d-block mb-2">${lead.nome}</strong>
                    <small class="text-muted d-block mb-2">
                        <i class="bi bi-telephone me-1"></i>${lead.telefone}
                    </small>
                    ${lead.valor_investimento ? `
                        <div class="mt-2 p-2" style="background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);border-radius:6px;">
                            <small class="text-success">
                                <i class="bi bi-cash-coin me-1"></i>R$ ${formatMoney(lead.valor_investimento)}
                            </small>
                        </div>
                    ` : ''}
                </div>
            `);
        }

        function formatMoney(v) {
            return new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 2 }).format(v);
        }
    </script>
</body>
</html>
