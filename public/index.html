<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOCIMOB - Sistema de Gestão Imobiliária</title>
    <link rel="icon" href="/assets/favicon.ico" sizes="any">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/glow.css">
    <script src="/js/login-utils.js" defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        // Configuração do tenant (será carregada dinamicamente)
        window.TENANT_CONFIG = null;
    </script>
</head>
<body class="glow-page">
    <!-- Navbar -->
    <nav class="glow-nav p-5">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="glow-badge text-lg">
                    <img id="navLogo" src="/assets/logo.png" alt="Logo" class="logo-glass h-12 w-12 object-contain">
                    <span id="navName">Carregando...</span>
                </div>
                <span id="navSlogan" class="hidden md:inline-flex glow-pill">Gestão Imobiliária</span>
            </div>
            <div class="flex gap-3 items-center">
                <a href="/app/login.html" class="glow-link">Área do Corretor</a>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="container mx-auto px-4 py-16 relative z-10">
        <div class="grid lg:grid-cols-[1.15fr_0.85fr] gap-10 items-start">
            <div class="space-y-8">
                <div class="glow-tagline">
                    <span class="h-3 w-3 bg-[var(--glow-red)] inline-block rounded-full"></span>
                    Plataforma completa para clientes, corretores e administradores.
                </div>
                <div class="space-y-6">
                    <h2 class="glow-hero-title font-black" id="heroTitle">
                        Encontre o <span class="glow-hero-highlight">Imóvel Perfeito</span>
                        <br>para Você
                    </h2>
                    <p id="heroDescription" class="text-xl max-w-2xl leading-relaxed text-[rgba(255,255,255,0.9)]">
                        Tecnologia e experiência para você comprar, vender ou alugar com segurança e praticidade.
                    </p>
                </div>

                <div class="grid gap-4 sm:grid-cols-2">
                    <div class="glow-card p-6">
                        <div class="text-4xl mb-3">🏠</div>
                        <h3 class="font-bold text-lg text-[var(--glow-ink)] mb-2">Imóveis Selecionados</h3>
                        <p class="text-sm text-[rgba(255,255,255,0.8)]">
                            Casas, apartamentos e terrenos com as melhores localizações e preços.
                        </p>
                    </div>
                    <div class="glow-card p-6">
                        <div class="text-4xl mb-3">💼</div>
                        <h3 class="font-bold text-lg text-[var(--glow-ink)] mb-2">Atendimento Personalizado</h3>
                        <p class="text-sm text-[rgba(255,255,255,0.8)]">
                            Corretores especializados para ajudar você em cada etapa do processo.
                        </p>
                    </div>
                </div>

                <div class="flex flex-wrap gap-3">
                    <span class="glow-chip">Busca com filtros dinâmicos</span>
                    <span class="glow-chip">Chat direto com corretores</span>
                    <span class="glow-chip">Dashboards administrativos</span>
                </div>
            </div>

            <!-- Login/Cadastro Section -->
            <div class="glow-panel relative overflow-hidden">
                <img id="loginLogo" src="/assets/logo.png" alt="Logo" class="hero-logo">
                <div class="text-center space-y-2 mb-6">
                    <h3 id="loginTitle" class="text-2xl font-black text-[var(--glow-ink)]">Bem-vindo</h3>
                    <p class="text-xs uppercase tracking-[0.4em] text-[rgba(255,255,255,0.7)]">
                        Um único login para admins, corretores e clientes.
                    </p>
                </div>

                <!-- Google Sign In Button -->
                <div id="g_id_onload"
                     data-client_id="YOUR_GOOGLE_CLIENT_ID"
                     data-callback="handleCredentialResponse"
                     data-auto_prompt="false">
                </div>

                <div class="mb-6">
                    <div id="g_id_signin"
                         data-type="standard"
                         data-size="large"
                         data-theme="outline"
                         data-text="continue_with"
                         data-shape="rectangular"
                         data-logo_alignment="left"
                         data-width="100%">
                    </div>
                </div>

                <div class="relative my-6">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-[rgba(255,255,255,0.15)]"></div>
                    </div>
                    <div class="relative flex justify-center text-xs uppercase tracking-[0.4em] text-[rgba(255,255,255,0.6)]">
                        <span class="px-4 bg-[rgba(2,7,20,0.95)]">ou use e-mail</span>
                    </div>
                </div>

                <div id="loginFeedback" role="status" aria-live="polite" class="glow-feedback hidden"></div>

                <!-- Email/Senha para clientes -->
                <form id="clientLoginForm" class="space-y-5">
                    <div class="space-y-2">
                        <label class="block text-sm font-extrabold text-[var(--glow-ink)] uppercase tracking-wide">Email</label>
                        <input
                            type="email"
                            id="clientEmail"
                            required
                            class="w-full glow-input"
                            placeholder="seu@email.com"
                        />
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-extrabold text-[var(--glow-ink)] uppercase tracking-wide">Senha</label>
                        <input
                            type="password"
                            id="clientSenha"
                            required
                            class="w-full glow-input"
                            placeholder="••••••••"
                        />
                    </div>

                    <button
                        type="submit"
                        class="w-full glow-button flex items-center justify-center gap-2"
                    >
                        <span id="btnLabel">Entrar</span>
                        <span id="btnLoading" class="hidden">Entrando...</span>
                    </button>
                </form>

                <div class="mt-6 text-center text-xs text-[rgba(255,255,255,0.7)]">
                    Acesso com Google cria conta automaticamente quando necessário.
                </div>

                <div class="mt-4 pt-5 border-t border-[rgba(255,255,255,0.15)] text-center text-xs">
                    <a href="/app/login.html" class="glow-link font-bold">Precisa do CRM completo? Clique aqui.</a>
                </div>
            </div>
        </div>

        <!-- Features -->
        <div class="mt-16 grid grid-cols-1 md:grid-cols-3 gap-6 relative z-10">
            <div class="glow-card rounded-xl p-8 text-center hover:scale-105 transition-transform">
                <div class="text-5xl mb-4">🔍</div>
                <h3 class="text-xl font-bold text-[var(--glow-ink)] mb-2">Busca Inteligente</h3>
                <p class="text-sm text-[rgba(255,255,255,0.8)]">
                    Encontre o imóvel ideal com filtros por localização, preço, tamanho e muito mais.
                </p>
            </div>
            <div class="glow-card rounded-xl p-8 text-center hover:scale-105 transition-transform">
                <div class="text-5xl mb-4">📱</div>
                <h3 class="text-xl font-bold text-[var(--glow-ink)] mb-2">Atendimento 24/7</h3>
                <p class="text-sm text-[rgba(255,255,255,0.8)]">
                    Chat direto com corretores e assistente virtual para tirar suas dúvidas a qualquer hora.
                </p>
            </div>
            <div class="glow-card rounded-xl p-8 text-center hover:scale-105 transition-transform">
                <div class="text-5xl mb-4">✅</div>
                <h3 class="text-xl font-bold text-[var(--glow-ink)] mb-2">Processo Seguro</h3>
                <p class="text-sm text-[rgba(255,255,255,0.8)]">
                    Documentação completa, vistorias e suporte jurídico em todas as negociações.
                </p>
            </div>
        </div>
    </div>

    <script>
        // Carregar configurações do tenant
        async function loadTenantConfig() {
            try {
                const response = await fetch('/api/tenant/config');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.tenant) {
                        window.TENANT_CONFIG = data.tenant;
                        applyTenantConfig(data.tenant);
                    }
                }
            } catch (error) {
                console.warn('Erro ao carregar config do tenant, usando padrão:', error);
            }
        }

        function applyTenantConfig(tenant) {
            console.log('🎨 Aplicando config do tenant:', tenant);
            
            // Atualizar título da página
            document.title = `${tenant.name || 'SOCIMOB'} - Sistema de Gestão Imobiliária`;
            
            // Criar logo placeholder com iniciais se não tiver logo
            const logoFallback = createLogoPlaceholder(tenant.name);
            
            // Atualizar navbar
            const navLogo = document.getElementById('navLogo');
            const navName = document.getElementById('navName');
            const navSlogan = document.getElementById('navSlogan');
            
            if (navLogo) {
                if (tenant.logo_url && tenant.logo_url !== '/assets/logo.png') {
                    navLogo.src = tenant.logo_url;
                    navLogo.onerror = () => { navLogo.style.display = 'none'; };
                } else {
                    navLogo.style.display = 'none';
                }
            }
            if (navName) navName.textContent = tenant.name || 'SOCIMOB';
            if (navSlogan && tenant.slogan) navSlogan.textContent = tenant.slogan;
            
            // Atualizar hero section
            const heroTitle = document.getElementById('heroTitle');
            if (heroTitle) {
                if (tenant.hero_title) {
                    heroTitle.innerHTML = tenant.hero_title;
                } else {
                    heroTitle.innerHTML = `Encontre o <span class="glow-hero-highlight">Imóvel Perfeito</span><br>para Você`;
                }
            }
            
            const heroDescription = document.getElementById('heroDescription');
            if (heroDescription) {
                if (tenant.hero_description) {
                    heroDescription.textContent = tenant.hero_description;
                } else if (tenant.description) {
                    heroDescription.textContent = tenant.description;
                }
            }
            
            // Atualizar painel de login - criar badge com iniciais ao invés de logo
            const loginLogo = document.getElementById('loginLogo');
            const loginTitle = document.getElementById('loginTitle');
            
            if (loginLogo) {
                if (tenant.logo_url && tenant.logo_url !== '/assets/logo.png') {
                    loginLogo.src = tenant.logo_url;
                    loginLogo.onerror = () => {
                        // Se falhar, substituir por badge com iniciais
                        const badge = createLogoBadge(tenant.name);
                        loginLogo.parentNode.replaceChild(badge, loginLogo);
                    };
                } else {
                    // Substituir por badge com iniciais
                    const badge = createLogoBadge(tenant.name);
                    loginLogo.parentNode.replaceChild(badge, loginLogo);
                }
            }
            if (loginTitle) loginTitle.textContent = `Bem-vindo à ${tenant.name || 'Portal'}`;
            
            // Aplicar cores personalizadas
            if (tenant.primary_color) {
                document.documentElement.style.setProperty('--tenant-primary', tenant.primary_color);
            }
            if (tenant.secondary_color) {
                document.documentElement.style.setProperty('--tenant-secondary', tenant.secondary_color);
            }
        }
        
        function createLogoBadge(name) {
            const initials = name.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
            const div = document.createElement('div');
            div.className = 'hero-logo';
            div.style.cssText = 'width: 120px; height: 120px; background: linear-gradient(135deg, var(--glow-purple) 0%, var(--glow-red) 100%); border-radius: 24px; display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: 900; color: white; margin: 0 auto 1.5rem; box-shadow: 0 0 40px rgba(168, 85, 247, 0.4);';
            div.textContent = initials;
            return div;
        }
        
        function createLogoPlaceholder(name) {
            const initials = name.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
            return `data:image/svg+xml,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect width="100" height="100" fill="%23a855f7"/><text x="50" y="50" font-size="40" fill="white" text-anchor="middle" dy=".3em" font-weight="bold">${initials}</text></svg>`)}`;
        }

        window.handleCredentialResponse = (response) => {
            const handler = window.__processGoogleToken;
            if (typeof handler === 'function') {
                handler(response?.credential);
            } else {
                window.__pendingGoogleToken = response?.credential;
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            // Carregar configurações do tenant primeiro
            loadTenantConfig();
            const loginForm = document.getElementById('clientLoginForm');
            const feedbackEl = document.getElementById('loginFeedback');
            const submitButton = loginForm?.querySelector('button[type="submit"]');
            const btnLabel = document.getElementById('btnLabel');
            const btnLoading = document.getElementById('btnLoading');

            const pendingToken = localStorage.getItem('token');
            const pendingUser = localStorage.getItem('user');

            if (pendingToken && pendingUser) {
                try {
                    const parsed = JSON.parse(pendingUser);
                    window.location.href = LoginUtils.getRedirectForRole(parsed.role);
                    return;
                } catch (error) {
                    console.warn('token inválido:', error);
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                }
            }

            loginForm?.addEventListener('submit', async (event) => {
                event.preventDefault();
                await attemptLogin();
            });

            async function attemptLogin() {
                const email = document.getElementById('clientEmail').value.trim();
                const senha = document.getElementById('clientSenha').value;

                if (!email || !senha) {
                    LoginUtils.showFeedback(feedbackEl, 'error', 'Informe e-mail e senha para continuar.');
                    return;
                }

                LoginUtils.clearFeedback(feedbackEl);
                LoginUtils.setButtonLoading({
                    button: submitButton,
                    label: btnLabel,
                    loadingIndicator: btnLoading,
                    isLoading: true
                });

                const { response, data, error } = await LoginUtils.fetchLogin(email, senha);

                if (error) {
                    console.error('Erro no login:', error);
                    LoginUtils.showFeedback(feedbackEl, 'error', 'Erro ao conectar com o servidor');
                } else if (!response?.ok || !data.success) {
                    LoginUtils.showFeedback(feedbackEl, 'error', data?.message || 'Credenciais inválidas');
                } else {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    LoginUtils.showFeedback(feedbackEl, 'success', `Bem-vindo(a), ${data.user.name}. Redirecionando...`);
                    setTimeout(() => {
                        window.location.href = LoginUtils.getRedirectForRole(data.user.role);
                    }, 750);
                }

                LoginUtils.setButtonLoading({
                    button: submitButton,
                    label: btnLabel,
                    loadingIndicator: btnLoading,
                    isLoading: false
                });
            }

            async function googleFlow(token) {
                if (!token) {
                    LoginUtils.showFeedback(feedbackEl, 'error', 'Token do Google não foi entregue.');
                    return;
                }

                LoginUtils.clearFeedback(feedbackEl);
                LoginUtils.setButtonLoading({
                    button: submitButton,
                    label: btnLabel,
                    loadingIndicator: btnLoading,
                    isLoading: true
                });

                try {
                    const response = await fetch(`${LoginUtils.API_URL}/auth/google`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token })
                    });
                    const payload = await response.json();

                    if (!response.ok || !payload.success) {
                        throw new Error(payload?.message || 'Erro ao fazer login com Google');
                    }

                    localStorage.setItem('token', payload.token);
                    localStorage.setItem('user', JSON.stringify(payload.user));
                    LoginUtils.showFeedback(feedbackEl, 'success', `Bem-vindo(a), ${payload.user.name}.`);
                    setTimeout(() => {
                        window.location.href = LoginUtils.getRedirectForRole(payload.user.role);
                    }, 750);
                } catch (err) {
                    console.error('Erro:', err);
                    LoginUtils.showFeedback(
                        feedbackEl,
                        'error',
                        err instanceof Error ? err.message : 'Erro ao conectar com o servidor'
                    );
                } finally {
                    LoginUtils.setButtonLoading({
                        button: submitButton,
                        label: btnLabel,
                        loadingIndicator: btnLoading,
                        isLoading: false
                    });
                }
            }

            window.__processGoogleToken = googleFlow;
            if (window.__pendingGoogleToken) {
                googleFlow(window.__pendingGoogleToken);
                window.__pendingGoogleToken = null;
            }
        });
    </script>
</body>
</html>























