<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SOCIMOB</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="sidebar.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="bootswatch-themes.js"></script>
    <script src="sidebar.js"></script>
</head>
<body class="bg-light">
    <main class="container py-4">
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h2 class="card-title h4 mb-2">Dashboard</h2>
                <p class="text-muted mb-4">Visão geral dos leads, imóveis e conversas</p>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <div class="small text-uppercase opacity-75">Leads</div>
                                <div id="statLeadsValue" class="display-4 fw-bold">0</div>
                                <p id="statLeadsDetail" class="small mb-0 opacity-75">Carregando...</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <div class="small text-uppercase opacity-75">Imóveis</div>
                                <div id="statPropertiesValue" class="display-4 fw-bold">0</div>
                                <p id="statPropertiesDetail" class="small mb-0 opacity-75">Atualizando...</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <div class="small text-uppercase opacity-75">Conversas</div>
                                <div id="statConversasValue" class="display-4 fw-bold">0</div>
                                <p id="statConversasDetail" class="small mb-0 opacity-75">Sincronizando...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = '/api';

        $(document).ready(function() {
            console.log('✓ Dashboard carregado');
            
            checkAuth();
        });

        function checkAuth() {
            const token = localStorage.getItem('token');
            const userStr = localStorage.getItem('user');

            if (!token || !userStr) {
                console.log('✗ Não autenticado, redirecionando...');
                window.location.href = 'login.html';
                return;
            }

            try {
                const user = JSON.parse(userStr);
                console.log('✓ Usuário:', user);

                fetchDashboardStats();

            } catch (e) {
                console.error('✗ Erro ao processar usuário:', e);
                window.location.href = 'login.html';
            }
        }

        function fetchDashboardStats() {
            const token = localStorage.getItem('token');
            const endpoint = token ? API_URL + '/dashboard/stats' : '/api-public/dashboard/stats';
            const headers = token ? { 'Authorization': 'Bearer ' + token } : {};

            $.ajax({
                url: endpoint,
                method: 'GET',
                headers,
                success: function(response) {
                    const payload = response && response.success ? response.data : response;
                    if (!payload) {
                        console.warn('V Dados do dashboard inválidos', response);
                        return;
                    }

                    updateStats(payload);
                },
                error: function(xhr) {
                    console.error('V Falha ao carregar stats', xhr.responseJSON || xhr.statusText);
                }
            });
        }

        function updateStats(stats) {
            const leads = stats.leads || {};
            const conversas = stats.conversas || {};
            const imoveis = stats.imoveis || {};

            setStat('#statLeadsValue', leads.total);
            setStat('#statPropertiesValue', imoveis.total);
            setStat('#statConversasValue', conversas.ativas ?? conversas.total);

            $('#statLeadsDetail').text(`Novos: ${formatNumber(leads.novos)} • Em atendimento: ${formatNumber(leads.em_atendimento)}`);
            $('#statPropertiesDetail').text(`Ativos: ${formatNumber(imoveis.ativos)}`);
            $('#statConversasDetail').text(`Hoje: ${formatNumber(conversas.hoje)} • Aguardando: ${formatNumber(conversas.aguardando)}`);
        }

        function setStat(selector, value) {
            $(selector).text(formatNumber(value));
        }

        function formatNumber(value) {
            const parsed = Number(value ?? 0);
            if (Number.isNaN(parsed)) {
                return '0';
            }

            return new Intl.NumberFormat('pt-BR').format(parsed);
        }
    </script>
</body>
</html>



