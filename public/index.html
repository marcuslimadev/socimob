<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOCIMOB - Sistema de Gestão Imobiliária</title>
    <link rel="icon" href="/assets/favicon.ico" sizes="any">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/glow.css">
    <script src="/js/login-utils.js" defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        // Configuração do tenant (será carregada dinamicamente)
        window.TENANT_CONFIG = null;
    </script>
</head>
<body class="glow-page">
    <!-- Navbar -->
    <nav class="glow-nav p-5">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="glow-badge text-lg">
                    <img id="navLogo" src="/assets/logo.png" alt="Logo" class="logo-glass h-12 w-12 object-contain">
                    <span id="navName">Carregando...</span>
                </div>
                <span id="navSlogan" class="hidden md:inline-flex glow-pill">Gestão Imobiliária</span>
            </div>
            <div class="flex gap-3 items-center">
                <a href="/app/login.html" class="glow-link">Área do Corretor</a>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="container mx-auto px-4 py-16 relative z-10">
        <div class="grid lg:grid-cols-[1.15fr_0.85fr] gap-10 items-start">
            <div class="space-y-8">
                <div class="glow-tagline">
                    <span class="h-3 w-3 bg-[var(--glow-red)] inline-block rounded-full"></span>
                    Plataforma completa para clientes, corretores e administradores.
                </div>
                <div class="space-y-4">
                    <h2 class="glow-hero-title font-black" id="heroTitle">
                        Gestão imobiliária fluida
                        <span class="glow-hero-highlight">enxuta, vibrante e pronta para você</span>
                    </h2>
                    <p id="heroDescription" class="text-lg max-w-3xl leading-relaxed text-[rgba(255,255,255,0.85)]">
                        A experiência Glow entrega login único, atendimento inteligente e painéis que respeitam seu papel (cliente, corretor ou administrador) sem precisar trocar de tela.
                    </p>
                </div>

                <div class="grid gap-4 sm:grid-cols-2">
                    <div class="glow-card p-5">
                        <div class="text-3xl mb-2">✨</div>
                        <p class="font-semibold text-[var(--glow-ink)]">
                            Login inteligente que percebe o seu papel e direciona para a área certa.
                        </p>
                    </div>
                    <div class="glow-card p-5">
                        <div class="text-3xl mb-2">💡</div>
                        <p class="font-semibold text-[var(--glow-ink)]">
                            Liquid glass, espaçamentos generosos e tipografia cuidada evitam branco sobre branco.
                        </p>
                    </div>
                </div>

                <div class="flex flex-wrap gap-3">
                    <span class="glow-chip">Busca com filtros dinâmicos</span>
                    <span class="glow-chip">Chat direto com corretores</span>
                    <span class="glow-chip">Dashboards administrativos</span>
                </div>
            </div>

            <!-- Login/Cadastro Section -->
            <div class="glow-panel relative overflow-hidden">
                <img id="loginLogo" src="/assets/logo.png" alt="Logo" class="hero-logo">
                <div class="text-center space-y-2 mb-6">
                    <h3 id="loginTitle" class="text-2xl font-black text-[var(--glow-ink)]">Bem-vindo</h3>
                    <p class="text-xs uppercase tracking-[0.4em] text-[rgba(255,255,255,0.7)]">
                        Um único login para admins, corretores e clientes.
                    </p>
                </div>

                <!-- Google Sign In Button -->
                <div id="g_id_onload"
                     data-client_id="YOUR_GOOGLE_CLIENT_ID"
                     data-callback="handleCredentialResponse"
                     data-auto_prompt="false">
                </div>

                <div class="mb-6">
                    <div id="g_id_signin"
                         data-type="standard"
                         data-size="large"
                         data-theme="outline"
                         data-text="continue_with"
                         data-shape="rectangular"
                         data-logo_alignment="left"
                         data-width="100%">
                    </div>
                </div>

                <div class="relative my-6">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-[rgba(255,255,255,0.15)]"></div>
                    </div>
                    <div class="relative flex justify-center text-xs uppercase tracking-[0.4em] text-[rgba(255,255,255,0.6)]">
                        <span class="px-4 bg-[rgba(2,7,20,0.95)]">ou use e-mail</span>
                    </div>
                </div>

                <div id="loginFeedback" role="status" aria-live="polite" class="glow-feedback hidden"></div>

                <!-- Email/Senha para clientes -->
                <form id="clientLoginForm" class="space-y-5">
                    <div class="space-y-2">
                        <label class="block text-sm font-extrabold text-[var(--glow-ink)] uppercase tracking-wide">Email</label>
                        <input
                            type="email"
                            id="clientEmail"
                            required
                            class="w-full glow-input"
                            placeholder="seu@email.com"
                        />
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-extrabold text-[var(--glow-ink)] uppercase tracking-wide">Senha</label>
                        <input
                            type="password"
                            id="clientSenha"
                            required
                            class="w-full glow-input"
                            placeholder="••••••••"
                        />
                    </div>

                    <button
                        type="submit"
                        class="w-full glow-button flex items-center justify-center gap-2"
                    >
                        <span id="btnLabel">Entrar</span>
                        <span id="btnLoading" class="hidden">Entrando...</span>
                    </button>
                </form>

                <div class="mt-6 text-center text-xs text-[rgba(255,255,255,0.7)]">
                    Acesso com Google cria conta automaticamente quando necessário.
                </div>

                <div class="mt-4 pt-5 border-t border-[rgba(255,255,255,0.15)] text-center text-xs">
                    <a href="/app/login.html" class="glow-link font-bold">Precisa do CRM completo? Clique aqui.</a>
                </div>
            </div>
        </div>

        <!-- Features -->
        <div class="mt-12 grid grid-cols-1 md:grid-cols-3 gap-5 relative z-10">
            <div class="glow-card rounded-xl p-6 text-center">
                <div class="text-4xl mb-3">🔍</div>
                <p class="text-lg font-bold text-[var(--glow-ink)]">Busca geométrica com filtros rápidos</p>
            </div>
            <div class="glow-card rounded-xl p-6 text-center">
                <div class="text-4xl mb-3">💬</div>
                <p class="text-lg font-bold text-[var(--glow-ink)]">Chat direto entre clientes e corretores</p>
            </div>
            <div class="glow-card rounded-xl p-6 text-center">
                <div class="text-4xl mb-3">🔒</div>
                <p class="text-lg font-bold text-[var(--glow-ink)]">Autenticação segura e multi-tenant</p>
            </div>
        </div>
    </div>

    <script>
        // Carregar configurações do tenant
        async function loadTenantConfig() {
            try {
                const response = await fetch('/api/tenant/config');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.tenant) {
                        window.TENANT_CONFIG = data.tenant;
                        applyTenantConfig(data.tenant);
                    }
                }
            } catch (error) {
                console.warn('Erro ao carregar config do tenant, usando padrão:', error);
            }
        }

        function applyTenantConfig(tenant) {
            // Atualizar título da página
            document.title = `${tenant.name || 'SOCIMOB'} - Sistema de Gestão Imobiliária`;
            
            // Atualizar navbar
            const navLogo = document.getElementById('navLogo');
            const navName = document.getElementById('navName');
            const navSlogan = document.getElementById('navSlogan');
            
            if (navLogo && tenant.logo_url) navLogo.src = tenant.logo_url;
            if (navName) navName.textContent = tenant.name || 'SOCIMOB';
            if (navSlogan && tenant.slogan) navSlogan.textContent = tenant.slogan;
            
            // Atualizar hero section
            const heroTitle = document.getElementById('heroTitle');
            if (heroTitle && tenant.hero_title) {
                heroTitle.innerHTML = tenant.hero_title;
            } else if (heroTitle && tenant.slogan) {
                heroTitle.innerHTML = `${tenant.name}<br><span class="glow-hero-highlight">${tenant.slogan}</span>`;
            }
            
            const heroDescription = document.getElementById('heroDescription');
            if (heroDescription && tenant.hero_description) {
                heroDescription.textContent = tenant.hero_description;
            }
            
            // Atualizar painel de login
            const loginLogo = document.getElementById('loginLogo');
            const loginTitle = document.getElementById('loginTitle');
            
            if (loginLogo && tenant.logo_url) loginLogo.src = tenant.logo_url;
            if (loginTitle) loginTitle.textContent = `Bem-vindo ao ${tenant.name || 'Portal'}`;
            
            // Aplicar cores personalizadas se configuradas
            if (tenant.primary_color) {
                document.documentElement.style.setProperty('--tenant-primary', tenant.primary_color);
            }
            if (tenant.secondary_color) {
                document.documentElement.style.setProperty('--tenant-secondary', tenant.secondary_color);
            }
        }

        window.handleCredentialResponse = (response) => {
            const handler = window.__processGoogleToken;
            if (typeof handler === 'function') {
                handler(response?.credential);
            } else {
                window.__pendingGoogleToken = response?.credential;
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            // Carregar configurações do tenant primeiro
            loadTenantConfig();
            const loginForm = document.getElementById('clientLoginForm');
            const feedbackEl = document.getElementById('loginFeedback');
            const submitButton = loginForm?.querySelector('button[type="submit"]');
            const btnLabel = document.getElementById('btnLabel');
            const btnLoading = document.getElementById('btnLoading');

            const pendingToken = localStorage.getItem('token');
            const pendingUser = localStorage.getItem('user');

            if (pendingToken && pendingUser) {
                try {
                    const parsed = JSON.parse(pendingUser);
                    window.location.href = LoginUtils.getRedirectForRole(parsed.role);
                    return;
                } catch (error) {
                    console.warn('token inválido:', error);
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                }
            }

            loginForm?.addEventListener('submit', async (event) => {
                event.preventDefault();
                await attemptLogin();
            });

            async function attemptLogin() {
                const email = document.getElementById('clientEmail').value.trim();
                const senha = document.getElementById('clientSenha').value;

                if (!email || !senha) {
                    LoginUtils.showFeedback(feedbackEl, 'error', 'Informe e-mail e senha para continuar.');
                    return;
                }

                LoginUtils.clearFeedback(feedbackEl);
                LoginUtils.setButtonLoading({
                    button: submitButton,
                    label: btnLabel,
                    loadingIndicator: btnLoading,
                    isLoading: true
                });

                const { response, data, error } = await LoginUtils.fetchLogin(email, senha);

                if (error) {
                    console.error('Erro no login:', error);
                    LoginUtils.showFeedback(feedbackEl, 'error', 'Erro ao conectar com o servidor');
                } else if (!response?.ok || !data.success) {
                    LoginUtils.showFeedback(feedbackEl, 'error', data?.message || 'Credenciais inválidas');
                } else {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    LoginUtils.showFeedback(feedbackEl, 'success', `Bem-vindo(a), ${data.user.name}. Redirecionando...`);
                    setTimeout(() => {
                        window.location.href = LoginUtils.getRedirectForRole(data.user.role);
                    }, 750);
                }

                LoginUtils.setButtonLoading({
                    button: submitButton,
                    label: btnLabel,
                    loadingIndicator: btnLoading,
                    isLoading: false
                });
            }

            async function googleFlow(token) {
                if (!token) {
                    LoginUtils.showFeedback(feedbackEl, 'error', 'Token do Google não foi entregue.');
                    return;
                }

                LoginUtils.clearFeedback(feedbackEl);
                LoginUtils.setButtonLoading({
                    button: submitButton,
                    label: btnLabel,
                    loadingIndicator: btnLoading,
                    isLoading: true
                });

                try {
                    const response = await fetch(`${LoginUtils.API_URL}/auth/google`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token })
                    });
                    const payload = await response.json();

                    if (!response.ok || !payload.success) {
                        throw new Error(payload?.message || 'Erro ao fazer login com Google');
                    }

                    localStorage.setItem('token', payload.token);
                    localStorage.setItem('user', JSON.stringify(payload.user));
                    LoginUtils.showFeedback(feedbackEl, 'success', `Bem-vindo(a), ${payload.user.name}.`);
                    setTimeout(() => {
                        window.location.href = LoginUtils.getRedirectForRole(payload.user.role);
                    }, 750);
                } catch (err) {
                    console.error('Erro:', err);
                    LoginUtils.showFeedback(
                        feedbackEl,
                        'error',
                        err instanceof Error ? err.message : 'Erro ao conectar com o servidor'
                    );
                } finally {
                    LoginUtils.setButtonLoading({
                        button: submitButton,
                        label: btnLabel,
                        loadingIndicator: btnLoading,
                        isLoading: false
                    });
                }
            }

            window.__processGoogleToken = googleFlow;
            if (window.__pendingGoogleToken) {
                googleFlow(window.__pendingGoogleToken);
                window.__pendingGoogleToken = null;
            }
        });
    </script>
</body>
</html>























