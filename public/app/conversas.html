<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversas - SOCIMOB</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="sidebar.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/glow.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="sidebar.js"></script>
    <script src="/js/internal-glow.js" defer></script>
    <script src="js/toast.js"></script>
    <style>
        :root {
            --card-bg: rgba(15, 23, 42, 0.75);
            --card-border: rgba(148, 163, 184, 0.45);
            --card-glow: rgba(248, 250, 252, 0.1);
            --pulse: rgba(59, 130, 246, 0.6);
            --text-muted: rgba(226, 232, 240, 0.8);
        }
        body {
            background: radial-gradient(circle at top, rgba(59, 130, 246, 0.25), transparent 40%), #020617;
            color: #f8fafc;
            min-height: 100vh;
        }
        section {
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            background: linear-gradient(145deg, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.6));
            box-shadow: 0 20px 45px rgba(2, 6, 23, 0.65);
        }
        nav {
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }
        
        /* Layout Sidebar + Chat */
        main {
            height: calc(100vh - 80px);
        }
        
        aside, section {
            height: 100%;
        }
        
        /* Cards de Conversa na Sidebar */
        .lead-card {
            position: relative;
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            background: transparent;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .lead-card:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        .lead-card.selected {
            background: rgba(59, 130, 246, 0.2);
            border-left: 3px solid rgb(59, 130, 246);
        }
        .lead-card.has-new {
            background: rgba(253, 204, 13, 0.05);
        }
        .lead-card.has-new::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 60%;
            background: rgb(253, 204, 13);
        }
        .stage-pill {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 999px;
            padding: 0.2rem 0.95rem;
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            background: rgba(59, 130, 246, 0.12);
            color: #bfdbfe;
        }
        .message-bubble.incoming {
            background: rgba(255, 255, 255, 0.05);
            color: #f8fafc;
        }
        .message-bubble.outgoing {
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(59, 130, 246, 0.7);
            color: #f8fafc;
        }
        .card-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .message-counter {
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            font-size: 0.8rem;
            font-weight: 600;
            color: #e0f2fe;
            background: rgba(56, 189, 248, 0.2);
            padding: 0.35rem 0.85rem;
            border-radius: 999px;
        }
        .message-counter.muted {
            color: rgba(255, 255, 255, 0.6);
            background: rgba(15, 23, 42, 0.6);
        }
        .chat-panel {
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            background: rgba(2, 6, 23, 0.65);
            box-shadow: 0 25px 60px rgba(2, 6, 23, 0.9);
        }
        
        /* Área de Mensagens */
        #mensagens {
            height: 100%;
            min-height: 400px;
        }
        #mensagens::-webkit-scrollbar {
            width: 6px;
        }
        #mensagens::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.4);
            border-radius: 999px;
        }
        #mensagens::-webkit-scrollbar-track {
            background: transparent;
        }
        
        /* Scrollbar da Sidebar */
        aside > div:last-child::-webkit-scrollbar {
            width: 6px;
        }
        aside > div:last-child::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.3);
            border-radius: 999px;
        }
    </style>
</head>
<body>
    <div class="min-h-screen flex flex-col">
        <nav class="flex items-center justify-between px-6 py-4">
            <div>
                <p class="text-xs uppercase tracking-[0.3em] text-slate-400">SOCIMOB / Central de Atendimento</p>
                <h1 class="text-3xl font-black text-white">Conversas</h1>
            </div>
            <div class="flex items-center gap-4">
                <span id="userName" class="text-sm font-semibold"></span>
                <button id="btnLogout" class="px-4 py-2 rounded-full bg-rose-600 text-white font-semibold">Sair</button>
            </div>
        </nav>
        
        <!-- Layout tipo WhatsApp: Sidebar + Chat -->
        <main class="flex-1 px-6 pb-6 overflow-hidden">
            <div class="h-full grid grid-cols-12 gap-4">
                
                <!-- Sidebar de Conversas (col-span-4) -->
                <aside class="col-span-4 flex flex-col section p-0 overflow-hidden">
                    <!-- Header da Sidebar -->
                    <div class="p-4 border-b border-white/10">
                        <div class="mb-3">
                            <p id="leadCount" class="text-lg font-bold text-white">0 conversas ativas</p>
                            <p id="leadMeta" class="text-xs text-slate-400">Atualizando...</p>
                        </div>
                        <input id="searchLead" type="search" placeholder="Buscar conversa..." 
                               class="w-full px-4 py-2 rounded-full bg-slate-900 text-white border border-white/10 focus:border-sky-500 focus:outline-none placeholder:text-slate-500 text-sm" />
                    </div>
                    
                    <!-- Lista de Conversas -->
                    <div id="leadCards" class="flex-1 overflow-y-auto">
                        <div class="p-4 text-slate-400 text-sm text-center">Carregando conversas...</div>
                    </div>
                </aside>

                <!-- Área de Chat (col-span-8) -->
                <section class="col-span-8 flex flex-col chat-panel overflow-hidden">
                    <!-- Header do Chat -->
                    <div id="chatHeader" class="hidden p-4 border-b border-white/10">
                        <div class="flex items-center justify-between gap-4">
                            <div class="flex-1 min-w-0">
                                <h2 id="chatNome" class="text-xl font-semibold text-white truncate"></h2>
                                <p id="chatInfo" class="text-sm text-slate-300 truncate"></p>
                            </div>
                            <div id="chatActions" class="flex gap-2 flex-shrink-0"></div>
                        </div>
                    </div>
                    
                    <!-- Estado Vazio -->
                    <div id="chatEmpty" class="flex-1 flex items-center justify-center text-slate-500">
                        <div class="text-center">
                            <p class="text-6xl mb-4">💬</p>
                            <p class="text-xl font-semibold mb-2">Selecione uma conversa</p>
                            <p class="text-sm text-slate-400">Escolha um lead na lista para iniciar</p>
                        </div>
                    </div>
                    
                    <!-- Área de Chat Ativa -->
                    <div id="chatArea" class="hidden flex-1 flex flex-col min-h-0">
                        <!-- Mensagens -->
                        <div id="mensagens" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
                        
                        <!-- Input de Mensagem -->
                        <div class="p-4 border-t border-white/10">
                            <form id="formMensagem" class="flex gap-3">
                                <input id="inputMensagem" type="text" placeholder="Digite sua mensagem..." 
                                       class="flex-1 px-4 py-3 rounded-2xl bg-slate-900 text-white border border-white/10 focus:outline-none focus:ring-2 focus:ring-sky-500" />
                                <button type="submit" class="px-6 py-3 rounded-2xl bg-sky-600 hover:bg-sky-700 text-white font-semibold transition-colors">
                                    Enviar
                                </button>
                            </form>
                        </div>
                    </div>
                </section>
                
            </div>
        </main>
    </div>

    <script>
        const API_URL = '/api';
        let conversationsCache = [];
        let conversaAtual = null;
        let mensagens = [];
        let currentUser = null;
        let pollTimer = null;
        let lastIncomingCounts = {};
        let firstLeadFetch = true;
        const stageLabels = {
            boas_vindas: 'Boas-vindas',
            coleta_dados: 'Coleta de dados',
            orcamento: 'Orçamento',
            localizacao: 'Localização',
            preferencias: 'Preferências',
            busca_imoveis: 'Busca imóveis',
            matching: 'Matching',
            apresentacao: 'Apresentação',
            interesse: 'Interesse',
            agendamento: 'Agendamento',
            atendimento_humano: 'Atendimento humano',
            sem_match: 'Sem match',
            refinamento: 'Refinamento',
            aguardando_info: 'Aguardando info'
        };
        const stageTagColors = {
            boas_vindas: 'linear-gradient(135deg, rgba(59,130,246,0.4), rgba(14,165,233,0.3))',
            coleta_dados: 'linear-gradient(135deg, rgba(14,165,233,0.4), rgba(6,182,212,0.3))',
            orcamento: 'linear-gradient(135deg, rgba(16,185,129,0.4), rgba(52,211,153,0.25))',
            localizacao: 'linear-gradient(135deg, rgba(234,179,8,0.35), rgba(250,204,21,0.2))',
            preferencias: 'linear-gradient(135deg, rgba(249,115,22,0.35), rgba(251,191,36,0.2))',
            busca_imoveis: 'linear-gradient(135deg, rgba(134,239,172,0.35), rgba(74,222,128,0.2))',
            matching: 'linear-gradient(135deg, rgba(236,72,153,0.35), rgba(251,113,133,0.3))',
            apresentacao: 'linear-gradient(135deg, rgba(59,130,246,0.35), rgba(129,140,248,0.2))',
            interesse: 'linear-gradient(135deg, rgba(99,102,241,0.35), rgba(129,140,248,0.25))',
            agendamento: 'linear-gradient(135deg, rgba(37,99,235,0.4), rgba(59,130,246,0.23))',
            atendimento_humano: 'linear-gradient(135deg, rgba(244,63,94,0.35), rgba(251,113,133,0.2))',
            sem_match: 'linear-gradient(135deg, rgba(113,128,150,0.35), rgba(120,113,171,0.2))',
            refinamento: 'linear-gradient(135deg, rgba(20,184,166,0.35), rgba(45,212,191,0.25))',
            aguardando_info: 'linear-gradient(135deg, rgba(249,115,22,0.35), rgba(251,191,36,0.2))'
        };
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        document.body.addEventListener('pointerdown', () => {
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }, { once: true });

        $(document).ready(function() {
            checkAuth();
            startLeadPolling();
            $('#btnLogout').on('click', handleLogout);
            $('#formMensagem').on('submit', handleSendMessage);
            $('#searchLead').on('input', handleLeadFilter);
        });

        function startLeadPolling() {
            fetchConversations();
            pollTimer = setInterval(fetchConversations, 3000);
        }

        function fetchConversations() {
            const token = localStorage.getItem('token');
            if (!token) return;
            $.ajax({
                url: API_URL + '/conversas',
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + token },
                success: function(response) {
                    if (!response?.success) {
                        return;
                    }
                    conversationsCache = (response.data || []).map(normalizeConversa);
                    updateLeadCards();
                    firstLeadFetch = false;
                }
            });
        }

        function normalizeConversa(conversa) {
            const leadName = conversa.lead_nome || conversa.lead_whatsapp_name || conversa.lead_email || conversa.telefone || 'Cliente';
            const leadBudgetMin = conversa.lead_budget_min ? Number(conversa.lead_budget_min) : null;
            const leadBudgetMax = conversa.lead_budget_max ? Number(conversa.lead_budget_max) : null;
            return {
                ...conversa,
                lead_profile: {
                    id: conversa.lead_id,
                    nome: leadName,
                    telefone: conversa.lead_telefone || conversa.telefone || 'N/A',
                    status: conversa.lead_status || 'novo',
                    budget_min: leadBudgetMin,
                    budget_max: leadBudgetMax
                },
                lead_name: leadName,
                last_message_preview: conversa.ultima_mensagem_text || conversa.last_message || '',
                user_messages_count: Number(conversa.user_messages_count ?? 0),
                total_messages: Number(conversa.total_messages ?? 0),
            };
        }

        function updateLeadCards() {
            const searchValue = $('#searchLead').val().toLowerCase();
            const filtered = conversationsCache.filter(conversa => {
                const searchable = [
                    conversa.lead_profile?.nome,
                    conversa.lead_profile?.telefone,
                    conversa.stage,
                    conversa.lead_profile?.status
                ].join(' ').toLowerCase();
                return searchable.includes(searchValue);
            });
            $('#leadMeta').text('Atualizado em ' + new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' }));
            $('#leadCount').text(`${filtered.length} leads em atendimento`);
            const cardsHtml = filtered.map(conversa => {
                const stageKey = conversa.stage || 'coleta_dados';
                const stageLabel = stageLabels[stageKey] || 'Atendimento';
                const stageStyle = stageTagColors[stageKey] || 'rgba(59, 130, 246, 0.12)';
                const statusLabel = conversa.lead_profile?.status?.replace('_', ' ') || conversa.status || 'Ativo';
                const budgetValue = conversa.lead_profile?.budget_max || conversa.lead_profile?.budget_min;
                const hasBudget = Boolean(budgetValue);
                const formattedBudget = hasBudget ? formatCurrency(budgetValue) : 'Compartilhe investimento';
                const lastActivity = conversa.ultima_atividade ? formatTime(conversa.ultima_atividade) : 'Sem atividade recente';
                const messageSnippet = conversa.last_message_preview || 'Ainda sem mensagens definidas';
                const userMessageCounter = conversa.user_messages_count ?? 0;
                const hasNewMessages = userMessageCounter > 0;
                
                return `
                    <div class="lead-card" data-id="${conversa.id}">
                        <div class="flex items-start gap-3">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <h3 class="text-base font-semibold text-white truncate">${conversa.lead_profile?.nome}</h3>
                                    ${hasNewMessages ? `<span class="flex-shrink-0 w-5 h-5 rounded-full bg-sky-500 text-white text-xs flex items-center justify-center font-bold">${userMessageCounter}</span>` : ''}
                                </div>
                                <p class="text-xs text-slate-400 truncate mb-2">${messageSnippet}</p>
                                <div class="flex items-center justify-between text-xs text-slate-500">
                                    <span>${formatPhone(conversa.lead_profile?.telefone)}</span>
                                    <span>${lastActivity}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('') || '<div class="p-4 text-sm text-slate-500 text-center">Nenhuma conversa encontrada</div>';
            $('#leadCards').html(cardsHtml);
            filtered.forEach(conversa => {
                const isNew = detectNewIncoming(conversa);
                if (isNew) {
                    markCardAsNew(conversa.id);
                }
            });
            highlightSelectedCard();
            $('.lead-card').on('click', function() {
                const id = Number($(this).data('id'));
                selectConversa(id);
            });
        }

        function detectNewIncoming(conversa) {
            const previous = lastIncomingCounts[conversa.id] ?? conversa.user_messages_count;
            lastIncomingCounts[conversa.id] = conversa.user_messages_count;
            if (firstLeadFetch) {
                return false;
            }
            return conversa.user_messages_count > previous;
        }

        function markCardAsNew(id) {
            const card = $(`[data-id="${id}"]`);
            card.addClass('has-new');
            setTimeout(() => card.removeClass('has-new'), 2600);
            playNotificationTone();
        }

        function highlightSelectedCard() {
            $('.lead-card').removeClass('selected');
            if (!conversaAtual) return;
            $(`[data-id="${conversaAtual.id}"]`).addClass('selected');
        }

        function handleLeadFilter() {
            updateLeadCards();
        }

        function checkAuth() {
            const token = localStorage.getItem('token');
            const userStr = localStorage.getItem('user');
            if (!token || !userStr) {
                window.location.href = 'login.html';
                return;
            }
            currentUser = JSON.parse(userStr);
            $('#userName').text(currentUser.name);
        }

        function selectConversa(id) {
            const next = conversationsCache.find(c => c.id === id);
            if (!next) return;
            conversaAtual = next;
            $('#chatStage').text(stageLabels[conversaAtual.stage] || 'Atendimento');
            $('#chatHeader').removeClass('hidden');
            $('#chatEmpty').hide();
            $('#chatArea').removeClass('hidden');
            $('#chatNome').text(conversaAtual.lead_profile?.nome);
            $('#chatInfo').text(`Lead #${conversaAtual.lead_profile?.id || '—'} | ${formatPhone(conversaAtual.lead_profile?.telefone)}`);
            renderChatActions(conversaAtual);
            highlightSelectedCard();
            loadMensagens(conversaAtual.id);
        }

        function loadMensagens(conversaId) {
            const token = localStorage.getItem('token');
            $.ajax({
                url: API_URL + '/conversas/' + conversaId,
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + token },
                success: function(response) {
                    mensagens = response.data?.mensagens || [];
                    renderMensagens(mensagens);
                },
                error: function() {
                    mensagens = [];
                    renderMensagens(mensagens);
                }
            });
        }

        function renderMensagens(data) {
            if (!data.length) {
                $('#mensagens').html('<div class="text-center text-slate-400 py-12">Nenhuma mensagem ainda. Inicie a conversa!</div>');
                return;
            }
            const html = data.map(msg => {
                const isUsuario = msg.direction === 'outgoing';
                return `
                    <div class="flex ${isUsuario ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-[80%]">
                            <div class="message-bubble ${isUsuario ? 'outgoing' : 'incoming'} rounded-2xl px-4 py-3">
                                <p>${msg.content || ''}</p>
                            </div>
                            <p class="text-[11px] text-slate-400 mt-2 ${isUsuario ? 'text-right' : 'text-left'}">${formatDateTime(msg.sent_at)}</p>
                        </div>
                    </div>
                `;
            }).join('');
            $('#mensagens').html(html);
            const mensagensDiv = document.getElementById('mensagens');
            mensagensDiv.scrollTop = mensagensDiv.scrollHeight;
        }

        function renderChatActions(conversa) {
            if (!conversa || conversa.canal !== 'portal') {
                $('#chatActions').html('');
                return;
            }
            const assumida = !!conversa.corretor_id;
            const isOwner = currentUser && conversa.corretor_id === currentUser.id;
            const takeBtn = `<button class="px-4 py-2 bg-slate-100 rounded-full text-slate-900 font-semibold" onclick="assumirConversa(${conversa.id})">Assumir</button>`;
            const releaseBtn = `<button class="px-4 py-2 border border-slate-100 rounded-full text-slate-100 font-semibold" onclick="liberarConversa(${conversa.id})">Liberar IA</button>`;
            if (!assumida) {
                $('#chatActions').html(takeBtn);
                return;
            }
            if (isOwner || (currentUser && (currentUser.role === 'admin' || currentUser.role === 'super_admin'))) {
                $('#chatActions').html(releaseBtn);
            } else {
                $('#chatActions').html('<span class="text-xs text-slate-400">Atendimento em outro corretor</span>');
            }
        }

        function handleSendMessage(e) {
            e.preventDefault();
            if (!conversaAtual) return;
            const texto = $('#inputMensagem').val().trim();
            if (!texto) return;
            const novaMensagem = {
                id: mensagens.length + 1,
                direction: 'outgoing',
                content: texto,
                sent_at: new Date().toISOString()
            };
            mensagens.push(novaMensagem);
            renderMensagens(mensagens);
            $('#inputMensagem').val('');
            const token = localStorage.getItem('token');
            $.ajax({
                url: API_URL + '/conversas/' + conversaAtual.id + '/mensagens',
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token },
                contentType: 'application/json',
                data: JSON.stringify({ content: texto }),
                success: function() {
                    console.log('Mensagem enviada.');
                },
                error: function() {
                    console.log('Falha ao enviar mensagem.');
                }
            });
        }

        function handleLeadFilter() {
            updateLeadCards();
        }

        function handleLogout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }

        function formatTime(datetime) {
            if (!datetime) return 'Sem registro';
            const date = new Date(datetime);
            const now = new Date();
            const diffMs = now - date;
            const diffMinutes = Math.floor(diffMs / 60000);
            if (diffMinutes < 1) return 'Agora mesmo';
            if (diffMinutes < 60) return `${diffMinutes} min atrás`;
            const diffHours = Math.floor(diffMinutes / 60);
            if (diffHours < 24) return `${diffHours} h atrás`;
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        }

        function formatDateTime(datetime) {
            if (!datetime) return '';
            return new Date(datetime).toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatPhone(value) {
            if (!value) return '---';
            const digits = value.replace(/\D/g, '');
            if (digits.length === 11) {
                return `+${digits[0]} (${digits.substr(1, 2)}) ${digits.substr(3, 5)}-${digits.substr(8)}`;
            }
            if (digits.length === 10) {
                return `(${digits.substr(0, 2)}) ${digits.substr(2, 4)}-${digits.substr(6)}`;
            }
            return value;
        }

        function formatCurrency(value) {
            if (value === null || value === undefined) return '—';
            const number = Number(value);
            if (Number.isNaN(number)) return '—';
            return 'R$ ' + number.toLocaleString('pt-BR');
        }

        function playNotificationTone() {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.value = 720;
            gain.gain.value = 0.15;
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.14);
        }
    </script>
</body>
</html>
